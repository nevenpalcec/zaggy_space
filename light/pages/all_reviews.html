<div class="view_items d-flex flex-column bg-white">
    <div class="view_header d-flex drop_shadow_md position-relative bg-white">

        <!-- left menu -->
        <div class="d-flex align-self-center">

            <!-- Mobile btn -->
            <div class="mobile_button black"></div>

            <div class="line_normal align-self-center font_5 font_bold text-uppercase">
                <i class="fas fa-star pr-2"></i> Reviews
            </div>
        </div>

        <!-- right shortcuts -->
        <div class="align-self-center ml-auto" id="header_navbar_right_shrotcuts"></div>

    </div>

    <!-- Filter -->
    <div class="view_filter bg-white d-flex align-items-center px-3">

        <!-- Calendar -->
        <div class="d-flex">
            <div id="all_reviews_filter_calendar" class="view_dropdown filter_calendar d-lg-block d-none">
                <button class="btn btn_hover  px-2 py-1 d-lg-block d-none">
                    <div class="d-flex align-items-center">
                        <i class="far fa-calendar-alt mr-3 font_7"></i>
                        <div class="dropdown_label mr-1">
                            <div class="font_1 text-uppercase font_bold text-left">Calendar</div>
                            <div class="font_bold">
                                <span id="calendar_filter_date_from" class="font_3 font_light text-left"></span> &minus;
                                <span id="calendar_filter_date_until" class="font_3 font_light text-left"></span>
                            </div>
                        </div>
                        <div class="btn_toogleArrow ml-2 font_1"><i class="fas fa-chevron-down"></i></div>
                    </div>
                </button>
                <div class="dropdown_menu calendar hidden">
                    <div id="all_reviews_filter_dropdown_calendar" class="filter_dropdown_calendar">
                    </div>
                    <div class="dropdown_footer d-flex">
                    </div>
                </div>
            </div>
        </div>

        <div class="filter_line_y"></div>

        <!-- Objects -->
        <div id="all_reviews_filter_object" class="view_dropdown dropdown d-md-block d-none">
            <button class="btn btn_hover px-2 py-1" id="all_reviews_button_object_filter">
                <div class="d-flex align-items-center mt-1">
                    <span class="font_7"><i class="fas fa-cube"></i></span>
                    <i class="fas fa-angle-down ml-2"></i>
                </div>
            </button>
            <div class="dropdown_menu filter_min_width hidden" id="all_reviews_object_filter">
                <ul class="dropdown_ul font_3 dropdown_ul_max_height" id="all_reviews_apartment_list">
                </ul>
            </div>
        </div>

        <div id="all_reviews_current_selected_object">
            <input id="all_reviews_current_selected_object_name" disabled />
        </div>

        <div class="filter_line_y ml-3 mr-3"></div>

        <!-- Search reviews -->
        <div class="filter_search_name position-relative">
            <input type="text" class="form-control focus" placeholder="Search..." id="all_reviews_input_search" onkeyup="all_reviews.bl.get_all()" style=" min-width: 9rem;">
            <span class="search_icon"><i class="fas fa-search" style="margin-top: .15rem;"></i></span>
        </div>

        <!--<div id="all_reviews_filter_object" class="view_dropdown dropdown h-auto">
        <button class="btn btn_hover px-2 py-1 w-100" id="all_reviews_button_object_filter">
            <div class="d-flex align-items-center w-100">
                <span class="mr-3 font_8 d-flex py-2"><i class="fas fa-cube"></i></span>
                <div class="dropdown_label mr-1">
                    <div class="font_1 text-uppercase font_bold text-left pb-1">
                        Object
                    </div>
                    <div class="font_3 dropdown_name white text-left">-</div>
                </div>
                <div class="btn_toogleArrow pl-2 ml-auto font_1">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </button>
        <div class="dropdown_menu w-100 hidden" id="all_reviews_object_filter">
            <ul id="all_reviews_apartment_list" class="dropdown_ul dropdown_icon ul_icon_white font_3" data-name="" style="max-height: 15rem; overflow-y: auto;">
            </ul>
        </div>
    </div>-->

        <a id="all_reviews_filter_object_btn" class="filter_link d-md-none d-block mobile btn"><i class="fas fa-cube"></i></a>

        <div class="filter_line_y ml-3 mr-3"></div>

        <!--<div>
        <input id="selected_filter_show" disabled />
    </div>-->
        <!-- Filters -->
        <div id="all_reviews_filter_show" class="view_dropdown dropdown d-md-block d-none">
            <button class="btn btn_hover px-2 py-1" id="all_reviews_button_filter_show">
                <div class="d-flex align-items-center">
                    <span class="font_7"><i class="fas fa-filter"></i></span>
                    <i class="fas fa-angle-down ml-2"></i>
                </div>
            </button>
            <div class="dropdown_menu filter_min_width hidden" id="all_reviews_filter_show_dropdown">
                <ul class="dropdown_ul font_3 dropdown_ul_max_height" id="all_reviews_filter_show_list">
                    <li class="dropdown_li" data-id="" onclick="all_reviews.bl.get_all('', '', '')"> Show all </li>
                    <li class="dropdown_li" data-id="N" onclick="all_reviews.bl.get_all('', '', 'N')"> Show only unread </li>
                    <li class="dropdown_li" data-id="Y" onclick="all_reviews.bl.get_all('', '', 'Y')"> Show only read </li>
                </ul>
            </div>
        </div>

        <div class="ml-auto">
            <button class="btn btn_green" onclick="all_reviews.bl.mark_all_as_seen();"><i class="far fa-check-circle pr-2"></i>Mark all as read</button>
        </div>

    </div>


    <!-- Page -->
    <div class="view_content bg-white position-relative pt-0">

        <!-- Loading -->
        <div id="reviews_content_loading" class="view_loading" style="display: none;">
            <img src="/assets/images/icons/loading.svg" />
        </div>

        <!-- Table -->
        <table class="table" id="table_reviews_list">
            <thead>
                <tr class="sticky bg_light_silver" style="height: auto !important">
                    <th scope="col" class="text-center border-0"><span class="text-capitalize">Source</span></th>
                    <th scope="col" class="border-0"><span class="text-capitalize">Reservation</span></th>
                    <th scope="col" class="border-0"><span class="text-capitalize">Object</span></th>
                    <th scope="col" class="border-0"><span class="text-capitalize">Date</span></th>
                    <th scope="col" class="text-right border-0">Rating</th>
                    <th scope="col" class="text-right border-0">Rating %</th>
                    <th scope="col" class="text-right border-0">Open</th>
                </tr>
            </thead>
            <tbody id="reviews_all_tbody">
            </tbody>
        </table>

    </div>
</div>

<!-- apartment list template-->
<div>
    <template id="template_apartment_list">
        <li class="dropdown_li" data-id="${id}" data-unit="${unit_id}" data-name="${name}" onclick="all_reviews.bl.get_all(${id}, `${name}`)">${name}</li>
    </template>
</div>

<!-- Modal add review -->
<section class="modal_add_review"></section>

<!-- templates -->
<section>

    <!-- reviews row -->
    <template id="template_reviews_tr">
        <tr class="cursor_point" onclick="modal_add_review.bl.edit_reviews(`${review_id}`);">

            <td class="text-center align-middle">
                <div>
                    <img width="30" height="30" src="/assets/images/icons/portals/${rent_source_icon}.svg" alt="" loading="lazy">
                </div>
            </td>

            <td>
                <div>
                    <span class="${hidden_flags}"><img width="16" height="16" src="/assets/images/icons/flags/${code2}.svg" alt="" loading="lazy"></span>
                    <span> ${contact_name} </span>
                </div>
            </td>

            <td class="align-middle">
                <div class="text-black-50">
                    ${object_name}
                </div>
            </td>

            <td>
                <div>
                    ${date}
                </div>
            </td>

            <td class="text-right align-middle">
                <div><strong> ${rating} </strong></div>
            </td>

            <td class="text-right align-middle">
                <div><strong> ${rating_score_percent} </strong></div>
            </td>

            <td class="text-right align-middle">
                <div><strong> ${opened} </strong></div>
            </td>
        </tr>
    </template>

</section>

<script>

    $(".modal_add_review").load("/pages/components/modal_add_reviews.html");
    $(".filter_general").load("/pages/partals/filter_general.html");

    var all_reviews = {};

    all_reviews.date_from = '';
    all_reviews.date_until = '';

    // Load function
    all_reviews.load = async () => {

        // set title
        document.title = "All reviews";

        $("#header_navbar_right_shrotcuts").load("/pages/partals/header_navbar_right_shrotcuts.html");
        $(".mobile_button").load("/pages/partals/mobile_navigation.html");

        // set calendar
        all_reviews.ui.double_calendar("all_reviews_filter_dropdown_calendar", "calendar_filter_date_from", "calendar_filter_date_until", "all_reviews_filter_calendar  > .dropdown_menu");
        all_reviews.ui.filter_dropdown("all_reviews_filter_calendar");
        ui.dropdown_text("all_reviews_filter_object");
        ui.dropdown_text("all_reviews_filter_show");
        all_reviews.ui.search();

        // load all objects
        all_reviews.bl.apartment_list();

        // load reviews
        all_reviews.bl.get_all();
    }

    all_reviews.bl = new function () {

        this.get_all = async (object_id_click, object_name_click, show_read_click) => {

            // load skeleton before fetching data
            ui.content_loading("reviews_content_loading");

            // set variables
            let date_from = js.date.toIso(calendar_filter_date_from.innerText);
            let date_until = js.date.toIso(calendar_filter_date_until.innerText);
            let contact_name = all_reviews_input_search.value ?? '';
            let object_id = '';
            let show_read = '';            

            if (typeof show_read_click != 'undefined' || show_read_click != null)
            {
                all_reviews_filter_show_dropdown.classList.add('hidden');
                all_reviews_filter_show_list.classList.remove('open');
                show_read = show_read_click;
            }

            all_reviews_current_selected_object_name.value = '';

            if (typeof object_id_click != 'undefined' || object_id_click != null)
            {
                all_reviews_object_filter.classList.add('hidden');
                all_reviews_button_object_filter.classList.remove("open");
                object_id = object_id_click;
                all_reviews_current_selected_object_name.value = object_name_click;
            }

            let url = `/api/reviews/list/?date_from=${date_from}&date_until=${date_until}&contact_name=${contact_name}&object_id=${object_id}&show_read=${show_read}`;
            let response = await ajax.get(url);
            let data = JSON.parse(response);

            // clear demo data
            reviews_all_tbody.innerHTML = '';

            // set data
            for (var r of data) {

                var t = template_reviews_tr.innerHTML;

                t = t.replaceAll('${review_id}', r['id']);
                t = t.replaceAll('${rent_source_icon}', r['icon'] ?? 'syncbeds');
                t = t.replaceAll('${hidden_flags}', r['code2'] ?? 'hidden');
                t = t.replaceAll('${code2}', r['code2']);
                t = t.replaceAll('${contact_name}', r['contact_name'] ?? '-');
                t = t.replaceAll('${object_name}', r['object_name'] ?? '-');
                t = t.replaceAll('${date}', r['date_string']);
                t = t.replaceAll('${rating}', r['rating_average'] == '0' ? '-' : Number(r['rating_average']).toFixed(2));
                t = t.replaceAll('${rating_score_percent}', Number(r['rating_score_percent']).toFixed(2));
                t = t.replaceAll('${opened}', r['open'] == 'Y' ? '<i class="fas fa-check"></i>' : '<i class="far fa-eye"></i>');

                js.html.insertAdjacentHTML('reviews_all_tbody', t);
            }

            // remove skeleton
            ui.content_loading_hide("reviews_content_loading");
        }

        // List of objects
        this.apartment_list = function () {

            var apartment_lista = JSON.parse(localStorage.getItem('objects'));
            all_reviews_apartment_list.innerHTML = '';

            js.html.insertAdjacentHTML('all_reviews_apartment_list', '<li class="dropdown_li" data-id="" onclick="all_reviews.bl.get_all(``,`All`,``)"> All </li>');

            for (var al of apartment_lista) {

                var t = template_apartment_list.innerHTML;

                t = t.replaceAll('${id}', al['id']);
                t = t.replaceAll('${unit_id}', al['unit_id']);
                t = t.replaceAll('${name}', al['name']);

                js.html.insertAdjacentHTML('all_reviews_apartment_list', t);
            }
        }

        // set all reviews as seen
        this.mark_all_as_seen = async () => {

            var url = '/api/reviews/mark_all_as_seen';
            await ajax.get(url);
            await all_reviews.bl.get_all();
        }
    }

    all_reviews.ui = new function () {

        // Filter - double calendar
        this.double_calendar = function (cal, input_from, input_until, close_calendar) {

            $("#" + cal).datepicker({

                firstDay: 1,
                numberOfMonths: 1,
                altFormat: "yy-mm-dd",

                onSelect: async function (dateText, inst) {

                    if (!input_from == true || !input_until == false) {

                        input_from = js.date.toIso(new Date(dateText));;
                        input_until = '';

                        $(this).datepicker();

                    } else {

                        input_until = js.date.toIso(new Date(dateText));

                        calendar_filter_date_from.innerHTML = input_from;
                        calendar_filter_date_until.innerHTML = input_until;

                        $(this).datepicker();

                        $("#" + close_calendar).addClass("hidden");
                        $(".btn").removeClass("open");

                        reviews_all_tbody.style.visibility = "hidden";

                        // load all reviews
                        await all_reviews.bl.get_all();

                        reviews_all_tbody.style.visibility = "visible";

                    }
                }
            });

            $("#" + cal).datepicker('setDate', new Date());

            // Set date
            var date_until = js.date.toIso(new Date());
            var date_from = js.date.add_month(new Date(), -12)
            //calendar_filter_date_from.innerHTML = js.date.toIso(new Date('2023-05-03'));
            calendar_filter_date_from.innerHTML = js.date.toIso(date_from);
            calendar_filter_date_until.innerHTML = js.date.add_day(date_until, 1);
        }

        // Filter dropdown
        this.filter_dropdown = function (id) {

            var id = document.getElementById(id);
            var btn = id.getElementsByClassName("btn")[0];
            var dropdown = id.lastElementChild;

            btn.addEventListener("click", function () {
                dropdownToggle();
            });

            document.addEventListener("mouseup", function (e) {

                if (id.outerHTML.includes(e.target.outerHTML) == false) {
                    dropdown.classList.add("hidden");
                    btn.classList.remove("open");
                }
            });

            function dropdownToggle() {

                if (!btn.classList.contains("open")) {
                    dropdown.classList.remove("hidden");
                    btn.classList.add("open");

                } else {
                    dropdown.classList.add("hidden");
                    btn.classList.remove("open");
                }
            }

            if (id.classList.contains("toggle")) {
                var dropdown_li = id.querySelectorAll(".dropdown_li");

                for (let i = 0; i < dropdown_li.length; i++) {
                    dropdown_li[i].addEventListener("click", function () {
                        dropdown.classList.add("hidden");
                        btn.classList.remove("open");
                    })
                }
            }

        }

        // Search reviews
        this.search = () => {

            // Init a timeout variable to be used below
            var timeout = null;

            // Listen for keystroke events
            all_reviews_input_search.onkeyup = function (e) {

                clearTimeout(timeout);

                // Make a new timeout set to go off in 500ms
                timeout = setTimeout(function () {
                    all_reviews.bl.get_all();
                }, 500);
            };

        }

    }

    // load
    all_reviews.load()

</script>