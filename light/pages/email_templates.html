<style>
    .text_border {
        border: 2px solid lightgrey;
        border-radius: 0.25rem;
        padding: 1.2rem !important
    }

    .active_tab {
        background-color: rgba(206, 212, 218, 0.5);
        border-radius: 0.45rem 0.45rem 0 0;
        position: relative;
        border-bottom: 5px solid #457b9d;
    }

    .tab_list {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 0;
        color: #000000;
    }

        .tab_list:hover {
            background-color: rgba(206, 212, 218, 0.5);
            border-radius: 0.45rem 0.45rem 0 0;
            text-decoration: none;
            color: black;
        }

    .selected {
        background: #d9ebf1;
        border-radius: 10%;
    }
</style>

<div class="view_items d-flex flex-column bg-white">

    <!-- Header -->
    <div class="view_header d-flex drop_shadow_md position-relative bg-white">
        <div class="d-flex align-self-center">

            <!-- Mobile btn -->
            <div class="mobile_button black"></div>

            <div class="line_normal align-self-center font_5 font_bold text-uppercase">
                <i class="fas fa-cogs pr-2"></i>User settings
            </div>
        </div>

        <div class="align-self-center ml-auto" id="header_navbar_right_shrotcuts"></div>

    </div>

    <!-- Filter -->
    <div class="view_filter bg-white d-flex flex-wrap align-items-center px-3">
        <a href="#settings" class="filter_link"><i class="fas fa-user-cog pr-lg-2"></i><span class="d-none d-lg-flex">Account</span></a>
        <div class="filter_line_y"></div>
        <a href="#rents_status" class="filter_link"><i class="fas fa-money-check pr-lg-2"></i><span class="d-none d-lg-flex">Status</span></a>
        <div class="filter_line_y"></div>
        <a href="#rents_sources" class="filter_link"><i class="fas fa-code-branch pr-lg-2"></i><span class="d-none d-lg-flex">Sources</span></a>
        <div class="filter_line_y"></div>
        <a href="#payments_methods" class="filter_link hidden"><i class="fas fa-file-invoice-dollar pr-lg-2"></i><span class="d-none d-lg-flex">Payment methods</span></a>
        <div class="filter_line_y hidden"></div>
        <a href="#evisitor" class="filter_link"><i class="fas fa-file-invoice-dollar pr-lg-2"></i><span class="d-none d-lg-flex">eVisitor</span></a>
        <div class="filter_line_y"></div>
        <a href="#invoice_text" class="filter_link"><i class="fas fa-file-invoice pr-lg-2"></i><span class="d-none d-lg-flex">Invoice text</span></a>
        <div class="filter_line_y"></div>
        <a href="#email_templates" class="filter_link active"><i class="fas fa-envelope pr-lg-2"></i><span class="d-none d-lg-flex">Email templates</span></a>
    </div>

    <!-- Page -->
    <div class="view_content bg-white position-relative pt-1">

        <!-- Loading -->
        <div id="email_templates_content_loading" class="view_loading" style="display: none;">
            <img src="/assets/images/icons/loading.svg" />
        </div>

        <!-- Content -->
        <div class="content pt-3">
            <div class="row">

                <!-- Special characters -->
                <div class="col-md-3 mb-4">
                    <div class="text_border">

                        <div>
                            <div class="font_bold text-uppercase pt-1 pb-3"><i class="fas fa-cubes pr-2"></i> Special characters </div>

                            <!--Search-->
                            <div class="col-md-8 p-0 mb-4">
                                <div class="form-group">
                                    <input id="characters_search" placeholder="Type to filter..." type="text" class="form-control mb-3" />
                                    <span class="value font_3 opacity_50"><i class="fas fa-search"></i></span>
                                </div>
                            </div>

                            <!-- Table -->
                            <div class="view_table" style="max-width: 1200px;">
                                <div class="table_wrapper">
                                    <table class="table">
                                        <tbody id="characters_tbody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="mt-2 d-flex justify-content-center align-middle">
                                <a onclick="email_template.ui.prev_page()" id="btn_prev">
                                    <i class="far fa-arrow-alt-circle-left font_4"></i>
                                </a>

                                <span id="page_span" class="px-4"></span>

                                <a onclick="email_template.ui.next_page()" id="btn_next">
                                    <i class="far fa-arrow-alt-circle-right font_4"></i>
                                </a>
                            </div>

                        </div>
                    </div>
                </div>


                <!-- Email template  -->
                <div class="col-md-6 mb-4">
                    <div class="text_border">

                        <!--Title-->
                        <div class="pb-4">
                            <div class="font_bold text-uppercase pt-1"><i class="fas fa-envelope pr-2"></i> Email template: <span id="email_template_id">-</span></div>
                        </div>

                        <!--Name & Subject-->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="mb-1">Name</label>
                                    <input type="text" id="email_template_name" value="-" class="form-control focus">
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="mb-1">Subject</label>
                                    <input type="text" id="email_template_subject" value="-" class="form-control focus">
                                </div>
                            </div>
                        </div>

                        <!--Email template & SMS template-->

                        <div class="pt-4">

                            <ul class="nav nav-tabs tab_pills_04" style="border-bottom: none;">
                                <li onclick="email_template.active_textearia = 'email';">
                                    <a id="a_template_tab_email" data-toggle="tab" href="#template_tab_email" class="tab_list active_tab px-4">
                                        <i class="far fa-paper-plane pr-2"></i><span>Email template</span>
                                    </a>
                                </li>
                                <li onclick="email_template.active_textearia = 'sms';">
                                    <a id="a_template_tab_sms" data-toggle="tab" href="#template_tab_sms" class="tab_list px-4">
                                        <i class="fas fa-mobile-alt pr-2"></i><span>SMS template</span>
                                    </a>
                                </li>
                            </ul>

                            <div class="tab-content">

                                <!--Template-->
                                <div id="template_tab_email" class="tab-pane active">
                                    <textarea id="template_body_email" class="form-control" rows="20"></textarea>
                                </div>

                                <!--SMS template-->
                                <div id="template_tab_sms" class="tab-pane">
                                    <textarea id="template_body_sms" cols="30" rows="5" class="form-control focus" placeholder="Price note"></textarea>
                                </div>
                            </div>

                            <div class="text-right pt-3">
                                <button class="btn btn_secondary" onclick="email_template.bl.save_template()"><i class="fas fa-save pr-2"></i>Save</button>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- List of email templates -->
                <div class="col-md-3 mb-4">
                    <div class="text_border">
                        <div class="pb-4">
                            <div class="d-flex justify-content-between">
                                <div class="font_bold text-uppercase pt-2"><i class="fas fa-envelope pr-2"></i> Email templates </div>
                                <button class="btn btn_secondary py-1" onclick="email_template.ui.show_details();">
                                    <i class="fas fa-plus pr-2"></i>Add
                                </button>
                            </div>


                            <div>
                                <ul id="languages_list" class="nav" style="margin: 14px 0;">
                                </ul>

                                <div class="view_table">
                                    <table class="table">
                                        <tbody id="templates_tbody"></tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!--templates-->
<section>

    <template id="template_lng_list">
        <li class="list-item">
            <a id="template_lng_${lng_id}" data-code="${country_code}" class="nav-link" onclick="email_template.bl.load_templates('${lng_id}', '${country_code}'); email_template.ui.set_selected_lng(this); "><img src="/assets/images/icons/flags/${country_code}.svg" style="width: 21px;"></a>
        </li>
    </template>

    <template id="email_template_tr">
        <tr onclick="email_template.bl.load_template_body(${template_id}); email_template.ui.set_selected_templ(this); " style="cursor: pointer;">
            <td class="">
                <img src="/assets/images/icons/flags/${country_code}.svg" class="mr-2" style="width: 16px;" /> ${template_name}
                <i class="icon-arrow-right14 pull-right"></i>
            </td>
        </tr>
    </template>

    <template id="template_characters_list">
        <tr class="character_tr" onclick="email_template.ui.texteria_append('${character}');" style="cursor: pointer;">
            <td>
                <code class="character_name">${character}</code>
            </td>
        </tr>
    </template>

    <template id="template_all_lngs_list">
        <li class="dropdown_li" data-id="${id}" data-name="">
            <div class="d-flex align-items-center">
                <img src="./assets/images/icons/flags/${code_iso_country}.svg" class="mr-2" style="width: 20px;">
                <span>${language}</span>
            </div>
        </li>
    </template>

</section>


<!--modals-->
<div>
    <div id="add_template_modal" class="view_modal hidden">
        <div class="modal_backdrop"></div>
        <div class="modal_dialog modal_lg">
            <div class="modal_content position-relative">

                <!-- header -->
                <div class="modal_header">
                    <div class="text-white font_5 align-self-center px-3 font-weight-bold">
                        <i class="fas fa-envelope pr-2"></i>Add new template
                    </div>
                    <div class="close" onclick="email_template.ui.modal_close();"><i class="fas fa-times"></i></div>
                </div>

                <!--body-->
                <div class="modal-body">

                    <div class="col-md-8">
                        <label class="my-1 font_5">Language:</label>

                        <!--Language-->
                        <div id="modal_filter_languages" class="view_dropdown dropdown dropdown_sm w-100" data-id="" data-name="">
                            <button class="btn btn_hover pl-2 pr-2 py-2 w-100 border">
                                <div class="d-flex align-items-center w-100">
                                    <div class="dropdown_label mr-1">
                                        <div class="font_4 dropdown_name white">
                                            Choose language...
                                        </div>
                                    </div>
                                    <div class="btn_toogleArrow pl-2 ml-auto font_1">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                            </button>
                            <div class="dropdown_menu w-100 hidden">
                                <div class="dropdown_search px-3 py-2">
                                    <input type="text" class="form-control" placeholder="Search">
                                </div>
                                <hr class="m-0">
                                <ul class="dropdown_ul ul_icon_white font_3" style="max-height: 15rem; overflow-y: auto;" id="add_template_modal_languages">
                                </ul>
                            </div>
                        </div>

                    </div>

                </div>

                <!--  footer -->
                <div class="modal-footer justify-content-end">
                    <button type="button" class="btn btn_secondary m-1" onclick="email_template.bl.add_template();">
                        <i class="fas fa-save pr-2"></i>Add template
                    </button>
                </div>

            </div>

        </div>

    </div>
</div>


<script>

    var email_template = {};

    email_template.user_id = bl.workers.current_user_id();

    email_template.characters = [];
    email_template.characters_tr = [];
    email_template.exsisting_lngs = [];
    email_template.current_page = 1;
    email_template.records_per_page = 20;
    email_template.num_pages = 0;
    email_template.active_textearia = 'email';

    // load function
    email_template.load = async () => {

        // Load
        $('.mobile_button').load('/pages/partals/mobile_navigation.html');
        $('#header_navbar_right_shrotcuts').load('/pages/partals/header_navbar_right_shrotcuts.html');

        // Global ui
        ui.display_title('Email templates');

        // Load language list
        await email_template.bl.load_languages();

        // Load all languages for modal add new template
        await email_template.bl.load_all_languages_list();

        // Initially - load list of english templates
        template_lng_1.click();

        // Load all special characters
        await email_template.bl.load_characters();

        // Load special characters on first page
        email_template.ui.change_page(1);

        email_template.ui.search_characters_listener();

        // Modal
        ui.dropdown_list("modal_filter_languages");
        email_template.ui.filter_search_list("modal_filter_languages");


        tinymce.init({
            selector: '#template_body_email',
            plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak code',
            toolbar_mode: 'floating',
            height: "1200"
        });

        a_template_tab_sms.addEventListener("click", function () {
            a_template_tab_sms.classList.add("active_tab");
            a_template_tab_email.classList.remove("active_tab");
        });

        a_template_tab_email.addEventListener("click", function () {
            a_template_tab_email.classList.add("active_tab");
            a_template_tab_sms.classList.remove("active_tab");
        });

    }

    email_template.ui = new function () {

        // Mark flag/language as selected
        this.set_selected_lng = async (selected_el) => {

            var seleced_elements = languages_list.querySelectorAll(".selected");
            seleced_elements.forEach(function (element) {
                element.classList.remove("selected");
            });

            selected_el.classList.add('selected');
        }

        // Mark template row as selected
        this.set_selected_templ = async (selected_el) => {

            var seleced_elements = templates_tbody.querySelectorAll(".selected");
            seleced_elements.forEach(function (element) {
                element.classList.remove("selected");
            });

            selected_el.classList.add('selected');
        }

        this.prev_page = () => {

            if (email_template.current_page > 1) {
                email_template.current_page--;
                email_template.ui.change_page(email_template.current_page);
            }
        }

        this.next_page = () => {

            if (email_template.current_page < email_template.num_pages) {
                email_template.current_page++;
                email_template.ui.change_page(email_template.current_page);
            }
        }

        this.change_page = (page) => {

            // Validate page
            if (page < 1) {
                page = 1;
            }

            if (page > email_template.num_pages) {
                page = email_template.num_pages;
            }

            characters_tbody.innerHTML = '';

            for (var i = (page - 1) * email_template.records_per_page; i < (page * email_template.records_per_page); i++) {

                if (!email_template.characters[i]) {
                    break;
                }

                js.html.insertAdjacentHTML('characters_tbody', email_template.characters_tr[i]);
            }
            page_span.innerHTML = page;

            if (page == 1) {
                btn_prev.style.visibility = "hidden";
            } else {
                btn_prev.style.visibility = 'visible';
            }

            if (page == email_template.num_pages) {
                btn_next.style.visibility = "hidden";
            } else {
                btn_next.style.visibility = "visible";
            }
        }

        this.texteria_append = (code) => {

            if (email_template.active_textearia == "sms") {

                var cursor_position = template_body_sms.selectionStart;
                let sms_value = template_body_sms.value;
                template_body_sms.value = sms_value.slice(0, cursor_position) + code + sms_value.slice(cursor_position)

            } else {
                tinymce.activeEditor.execCommand('mceInsertContent', false, code);
            }
        }

        this.search_characters_listener = () => {

            let timeout = null;

            characters_search.addEventListener('keyup', function (e) {

                clearTimeout(timeout);

                var filter = characters_search.value.toUpperCase();

                if (!filter == false) {

                    characters_tbody.innerHTML = '';

                    timeout = setTimeout(function () {

                        for (i = 0; i < email_template.characters.length; i++) {

                            var txtValue = email_template.characters[i].toUpperCase();

                            if (txtValue.indexOf(filter) > -1) {
                                js.html.insertAdjacentHTML('characters_tbody', email_template.characters_tr[i]);
                            }
                        }
                    }, 1000);

                }
                else {
                    email_template.ui.change_page(page_span.innerText);
                }

            });
        }

        // Modal - open details
        this.show_details = async () => {

            add_template_modal.classList.remove('hidden');
            add_template_modal.classList.remove('visuallyhidden');

        }

        // Modal - close details
        this.modal_close = () => {

            add_template_modal.classList.add('visuallyhidden');
            add_template_modal.addEventListener('transitionend', function (e) {
                add_template_modal.classList.add('hidden');
            }, {
                capture: false,
                once: true,
                passive: false
            });

        }
        // Modal add template - filter for search language
        this.filter_search_list = function (id) {

            let filter_id = document.getElementById(id);
            let li = filter_id.querySelectorAll(".dropdown_li");
            let input = filter_id.getElementsByClassName("form-control")[0];

            document.addEventListener("keyup", function () {

                filter = input.value.toUpperCase();
                for (let i = 0; i < li.length; i++) {
                    let list = li[i].children[0].lastElementChild;
                    textValue = list.textContent || list.innerText;
                    if (textValue.toUpperCase().indexOf(filter) > -1) {
                        li[i].style.display = "";
                    } else {
                        li[i].style.display = "none";
                    }
                }
            })
        }



    }

    email_template.bl = new function () {

        // Add new template
        this.add_template = async () => {

            var user_id = email_template.user_id;
            var language_id = modal_filter_languages.dataset.id;

            var url = `/api/emails_templates/add/?user_id=${user_id}&language_id=${language_id}`;
            var templ_id = await ajax.get_json(url);

            // Close modal
            email_template.ui.modal_close();

            // Refresh languages list
            if (!email_template.exsisting_lngs.includes(language_id)) {
                await email_template.bl.load_languages();
            }

            // Reload templates for new language
            document.getElementById('template_lng_' + language_id).click();

            // Load template body
            email_template.bl.load_template_body(templ_id);

        }

        // Save template
        this.save_template = async () => {

            if (email_template_id.innerText != '-') {

                data = {};

                data.id = email_template_id.innerText;
                data.name = email_template_name.value;
                data.subject = email_template_subject.value;
                data.body_email = tinymce.get('template_body_email').getContent();
                data.body_sms = template_body_sms.value;

                var url = '/api/emails_templates/save_template_simple/';
                await ajax.post_json(url, data);
            }
        }

        // Loading languages
        this.load_languages = async () => {

            var url = `/api/emails_templates/get_languages/?id=${email_template.user_id}`;
            email_template.exsisting_lngs = await ajax.get_json(url);

            languages_list.innerHTML = '';

            for (var l of email_template.exsisting_lngs) {

                var t = template_lng_list.innerHTML;

                t = t.replaceAll('${active}', 'active');
                t = t.replaceAll('${code}', l['code']);
                t = t.replaceAll('${country_code}', l['code_iso_country']);
                t = t.replaceAll('${lng_id}', l['id']);

                js.html.insertAdjacentHTML('languages_list', t);
            }

        }

        // loading all lanhuages into dropdown menu
        this.load_all_languages_list = async () => {

            var url = 'api/languages/list';
            var languages_list_all = await ajax.get_json(url);

            add_template_modal_languages = '';

            for (var l of languages_list_all) {
                var t = template_all_lngs_list.innerHTML;

                t = t.replaceAll('${id}', l['id']);
                t = t.replaceAll('${code_iso_country}', l['code_iso_country']);
                t = t.replaceAll('${language}', l['language']);

                js.html.insertAdjacentHTML('add_template_modal_languages', t);
            }

        }

        // Loading templates
        this.load_templates = async (lng_id, code_iso_country) => {

            var type = 'rent';
            var url = `/api/emails_templates/emails/?id=${email_template.user_id}&type=${type}&lng_id=${lng_id}`;
            var templates = await ajax.get_json(url);

            templates_tbody.innerHTML = '';

            for (var t of templates) {

                var tr = email_template_tr.innerHTML;

                tr = tr.replaceAll('${template_id}', t['id']);
                tr = tr.replaceAll('${template_name}', t['name']);
                tr = tr.replaceAll('${country_code}', code_iso_country);

                js.html.insertAdjacentHTML('templates_tbody', tr);
            }

        }

        // Loading characters
        this.load_characters = async () => {

            var url = `/api/rents/list_characters/?user_id=${email_template.user_id}`;
            email_template.characters = await ajax.get_json(url);
            email_template.characters = email_template.characters.sort();

            email_template.characters_tr = [];

            for (var c of email_template.characters) {

                var tr = template_characters_list.innerHTML;
                tr = tr.replaceAll('${character}', c);

                email_template.characters_tr.push(tr);
            }

            email_template.num_pages = Math.ceil(email_template.characters.length / email_template.records_per_page);

        }


        // Load template body
        this.load_template_body = async (templ_id) => {

            var url = `/api/emails_templates/get/?id=${templ_id}`;
            var template = await ajax.get_json(url);

            email_template_id.innerText = templ_id;
            email_template_name.value = template[0]['name'];
            email_template_subject.value = template[0]['subject'];

            var email_body = !template[0]['body'] == true ? '' : template[0]['body'];

            var editor = tinymce.get('template_body_email');
            if (editor) {
                editor.setContent(email_body);
            }

            template_body_sms.value = template[0]['body_sms'];
        }

    }

    // Load
    email_template.load();


</script>
